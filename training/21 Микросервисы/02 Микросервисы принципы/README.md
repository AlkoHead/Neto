
# Домашнее задание к занятию «Микросервисы: принципы»


Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Ответ

| Требование/Решение | Kong | KrakenD | NGINX (OpenResty) | Traefik |
|--------------------|------|---------|-------|---------|
| Маршрутизация запросов | Гибкая маршрутизация по хосту, пути, заголовкам и т.д. Поддержка декларативной конфигурации (YAML/DB). | Основан на конфигурационном файле (JSON/YAML). Поддержка сложной маршрутизации, агрегации данных. | Маршрутизация через location, map, регулярные выражения. Гибкая, но требует ручной настройки. | Автоматическая маршрутизация на основе меток (labels) в оркестраторах (Docker, Kubernetes) или статическая конфигурация. |
| Проверка аутентификации | Встроенная поддержка множества плагинов: JWT, OAuth2, Key Auth, LDAP и др. Можно писать кастомные. | Поддержка JWT, OAuth2. Возможна кастомная логика через middleware (Go/JS), но не так расширяемо, как у Kong. | Статическая через nginx.conf или с использованием модулей (например, JWT, Basic Auth) | Поддержка Basic Auth, JWT (через middleware), OAuth2 (в Traefik Enterprise). В OSS-версии — ограниченные возможности. |
| Терминация HTTP | Встроена, поддержка автоматического обновления сертификатов через ACME (в новых версиях). | Поддержка TLS, SNI, клиентских сертификатов. ACME — с ограничениями (лучше встраивать за Let’s Encrypt reverse-proxy). | NGINX — промышленный стандарт для TLS-терминации. Полная поддержка ACME, OCSP stapling, современных шифров. | Встроенный Let’s Encrypt ACME, автоматическая генерация и обновление сертификатов. Простая настройка TLS. |

И это не полный набор, есть еще например, `HAProxy` на нем тоже можно выполнить API GateWay. У облачных провайдеров есть свои облачные сервисы API GateWay. По собранной информации, наиболе популярен `API Gateway Kong`.

**Kong:**
- Идеален, если требуется гибкая аутентификация и авторизация (JWT, OAuth2, OpenID Connect и др.) «из коробки».
- Имеет мощную систему плагинов, включая enterprise-функции (rate limiting, bot detection, mTLS и т.д.).
- Поддерживает декларативную конфигурацию, что упрощает CI/CD.
- HTTPS-терминация реализована надёжно, особенно в связке с Let’s Encrypt.
- Подходит как для monolith, так и для микросервисных архитектур.

P.S. с `NGINX` больше "встречался", НО по заданию я *крутой* DevOps-специалист 

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

## Ответ

| требования\решение | Apache Kafka | RabbitMQ | Redis | NATS |
|--------------------|--------------|----------|-------|------|
| поддержка кластеризации | Да (репликация партиций, отказоустойчивость через ZooKeeper/KRaft) | Да ( mirrored queues, кластеры с RAM/disk-нодами) | через Redis Cluster, но Pub/Sub не реплицируется | Да (JetStream поддерживает реплицированные потоки в кластере) |
| хранение сообщений | по умолчанию (лог — файлы на диске, настраиваемое хранение) | Да (для durable queues), но по умолчанию — в RAM | Условно сохраняется в памяти + RDB/AOF дампы, но не «дисковая очередь» | в базовой версии — in‑memory; JetStream добавляет дисковое хранение |
| скорость работы | Очень высокая десятки–сотни тысяч сообщений/сек, оптимизирован под throughput | Средняя–высокая (зависит от durability; без persistence — быстро, с ней — медленнее) | Очень высокая (в памяти, но с ограничениями по объёму) | Очень высокая (миллионы сообщений/сек) |
| форматы сообщений | любой, обычно JSON/Avro/Protobuf | любой бинарный, часто JSON/XML, AMQP, MQTT | любой строковый/бинарный (JSON, Strings, Lists, Sets, Hashes) | любой, без схемы  |
| разделение прав | ACL, SASL, SSL, RBAC в Kafka ACL | Пользователи, виртуальные хосты, ресурсы, Topic/queue/exchange-level | Redis 6+ поддерживает ACL, но управление правами на Streams — на уровне ключей, не потоков | Простая парольная аутентификация, Нет fine-grained ACL на потоки |
| простота эксплуатации | Сложно (требует ZooKeeper или KRaft, настройка тонкая, мониторинг сложный) | Просто (интуитивный UI, понятная модель, легко развернуть, много инструментов) | Крайне простая установка, минимальная конфигурация, Но: persistence требует настройки | Просто–средне (JetStream требует понимания subjects, streams, consumers; но конфигурация — через YAML/CLI) |

**Обоснование выбора RabbitMQ**
Плюсы:
- Полноценная кластеризация с зеркалированием очередей.
- Надёжное дисковое хранение (можно настроить durable очереди).
- Гибкая система прав (виртуальные хосты, детальные ACL).
- Поддержка любых форматов (нет жёсткой схемы).
- Большое сообщество и документация.
- Простота эксплуатации: RabbitMQ имеет удобную веб-консоль для настройки и мониторинга, что упрощает эксплуатацию и уменьшает время на настройку системы.

Минусы:
- Скорость ниже
- Требует внимания к настройке HA.

